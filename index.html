<!DOCTYPE HTML>
<html>
<head>
    <link href="http://bootswatch.com/cyborg/bootstrap.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href="cornerstone.min.css" rel="stylesheet">
</head>
<style>

    .hidden {
        display: none;
    }

    /* images are displayed in viewports */
    .viewport {
        width:100%;
        height:100%;
        top:0px;
        left:0px;
        position:absolute
    }

    .overlay {
        position: absolute
    }

    .imageViewer {
    }

    .viewportWrapper {

    }
    .renderTime {}

</style>
<body>
<div id="wrap">
    <nav class="navbar navbar-default" rol="navigation">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="https://github.com/chafey/cornerstone">Cornerstone</a>
            </div>
            <ul class="nav navbar-nav navbar-right">
                <li><a id="help" href="#" class="button">Help</a></li>
            </ul>

        </div>
    </nav>
    <div">
        <ul id="tabs" class="nav nav-tabs">
            <li class="active"><a href="#studyList" data-toggle="tab">Study List</a></li>
        </ul>

        <div id="tabContent" class="tab-content" style="height:100%">
            <div id="studyList" class="tab-pane active">
                <div class="row">
                    <table style="margin-left:10px" class="col-md-12 table table-striped">
                        <thead>
                        <tr>
                            <th>Patient Name</th>
                            <th>Patient ID</th>
                            <th>Study Date</th>
                            <th>Modality</th>
                            <th>Study Description</th>
                            <th># Images</th>
                        </tr>
                        </thead>
                        <tbody id="studyListData">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="studyViewerTemplate" class="tab-pane active hidden">
            <div class="row">
                <div class="col-xs-2">
                    <h4>Select Series</h4>
                    <div class="list-group">
                    </div>
                </div>
                <div class="col-xs-10">
                    <button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="WW/WC"><span class="fa fa-adjust"></span></button>
                    <button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="Zoom"><span class="fa fa-search"></span></button>
                    <button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="Pan"><span class="fa fa-arrows"></span></button>
                    <button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="Stack Scroll"><span class="fa fa-bars"></span></button>
                    <button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="Length Measurement"><span class="fa fa-arrows-v"></span></button>
                    <button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="Pixle Probe"><span class="fa fa-dot-circle-o"></span></button>
                    <button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="Elliptical ROI"><span class="fa fa-circle-o"></span></button>
                    <button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="Rectangle ROI"><span class="fa fa-square-o"></span></button>
                    <div class="imageViewer">
                        <div class="viewportWrapper" style="width:100%;height:100%;position:relative;color: white;display:inline-block;background-color:black;"
                             oncontextmenu="return false"
                             class='cornerstone-enabled-image'
                             unselectable='on'
                             onselectstart='return false;'
                             onmousedown='return false;'>
                            <div class="viewport">
                            </div>
                            <div class="overlay" style="top:0px; left:0px">
                                <div>Patient Name</div>
                                <div>Patient Id</div>
                            </div>
                            <div class="overlay" style="top:0px; right:0px">
                                <div>Study Description</div>
                                <div>Study Date</div>
                            </div>
                            <div class="overlay" style="bottom:0px; right:0px">
                                <div class="currentImageAndTotalImages">Image #:</div>
                                <div>Zoom:</div>
                            </div>
                            <div class="overlay" style="bottom:0px; left:0px">
                                <div class="renderTime">Render Time:</div>
                                <div>WW/WC:</div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Instructions</h4>
            </div>
            <div class="modal-body">
                <ol>
                    <li>Select a study in the study list to view its images, a new tab will be created for each study.</li>
                    <li>Interact with the image using your mouse: left click drag - ww/wl, middle click drag - pan, right click drag - zoom, mouse wheel - scroll through stack</li>
                    <li>Select another series to display by left click the series list on the left</li>
                    <li>Select another tool to use with the left mouse button by selecting the tool button</li>
                </ol>
                <br>
                This demo requires a HTLM5 browser, Google Chrome is recommended.
                <br>
                Read about the <a href="architecture.html">architecture</a> for this demo
             </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-2.1.0.min.js"></script>

<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" ></script>

<!-- include the cornerstone library -->
<script src="cornerstone.min.js"></script>

<!-- include the cornerstone tools library -->
<script src="cornerstoneTools.min.js"></script>

<!-- include the cornerstoneWADOImageLoader library -->
<script src="cornerstoneWADOImageLoader.min.js"></script>

<!-- include the dicomParser library -->
<script src="dicomParser.min.js"></script>

    <script>

    $('#tabs a').click(function (e) {
        e.preventDefault()
        $(this).tab('show')
    })

    function loadStudyJson(studyViewer, studyId)
    {
        $.getJSON('studies/' + studyId, function(data) {
            // Load the first series into the viewport
            $('#wadoURL').val();

            var stacks = [];

            var seriesIndex = 0;
            data.seriesList.forEach(function(series) {
                var stack = {
                    seriesDescription: series.seriesDescription,
                    stackId : series.seriesNumber,
                    imageIds: [],
                    seriesIndex : seriesIndex,
                    currentImageIdIndex: 0,
                }
                series.instanceList.forEach(function(image) {
                    var imageId = "http://cornerstonetech.org/images/ClearCanvas/" + image.imageId;
                    stack.imageIds.push(imageId);
                });
                seriesIndex++;
                stacks.push(stack);
            });

            // resize the parent div of the viewport to fit the screen
            var imageViewer = $(studyViewer).find('.imageViewer')[0];
            var viewportWrapper = $(imageViewer).find('.viewportWrapper')[0];
            var parentDiv = $(studyViewer).find('.col-xs-10')[0];
            viewportWrapper.style.width = (parentDiv.style.width - 10) + "px";
            viewportWrapper.style.height= (window.innerHeight - 180) + "px";


            // image enable the dicomImage element and activate a few tools
            var element = $(studyViewer).find('.viewport')[0];
            var parent = $(element).parent();
            var childDivs = $(parent).find('.overlay');
            var topLeft = $(childDivs[0]).find('div');
            $(topLeft[0]).text(data.patientName);
            $(topLeft[1]).text(data.patientId);
            var topRight= $(childDivs[1]).find('div');
            $(topRight[0]).text(data.studyDescription);
            $(topRight[1]).text(data.studyDate);
            var bottomLeft = $(childDivs[2]).find('div');
            $(bottomLeft[1]).text("# Images: " + stacks[0].imageIds.length);
            var bottomRight = $(childDivs[3]).find('div');
            function onViewportUpdated(e) {
                $(bottomRight[0]).text("WW/WL:" + Math.round(e.detail.viewport.voi.windowWidth) + "/" + Math.round(e.detail.viewport.voi.windowCenter));
                $(bottomLeft[0]).text("Zoom:" + e.detail.viewport.scale.toFixed(2));
            };
            element.addEventListener("CornerstoneViewportUpdated", onViewportUpdated, false);
            function onNewImage(e) {
                var stackData = cornerstoneTools.getToolState(element, 'stack');
                if(stackData === undefined || stackData.data === undefined || stackData.data.length === 0) {
                    return;
                }
                var stack = stackData.data[0];
                $(bottomLeft[1]).text("Image #" + (stack.currentImageIdIndex + 1) + "/" + stack.imageIds.length);
            }
            element.addEventListener("CornerstoneNewImage", onNewImage, false);

            function onImageRendered(e) {
                $(bottomRight[1]).text("Render Time:" + cornerstone.lastRenderTimeInMs + " ms");
            }
            element.addEventListener("CornerstoneImageRendered", onImageRendered, false);


            var imageId = stacks[0].imageIds[0];

            // image enable the dicomImage element
            cornerstone.enable(element, imageId);
            cornerstoneTools.mouseInput.enable(element);
            cornerstoneTools.mouseWheelInput.enable(element);

            // Enable all tools we want to use with this element
            cornerstoneTools.wwwc.activate(element, 1); // ww/wc is the default tool for left mouse button
            cornerstoneTools.pan.activate(element, 2); // pan is the default tool for middle mouse button
            cornerstoneTools.zoom.activate(element, 4); // zoom is the default tool for right mouse button
            cornerstoneTools.probe.enable(element);
            cornerstoneTools.length.enable(element);
            cornerstoneTools.ellipticalRoi.enable(element);
            cornerstoneTools.rectangleRoi.enable(element);


            // stack tools
            cornerstoneTools.addStackStateManager(element);
            cornerstoneTools.addToolState(element, 'stack', stacks[0]);
            cornerstoneTools.stackScrollWheel.activate(element);
            cornerstoneTools.stackPrefetch.enable(element);


            function disableAllTools()
            {
                cornerstoneTools.wwwc.disable(element);
                cornerstoneTools.pan.activate(element, 2); // 2 is middle mouse button
                cornerstoneTools.zoom.activate(element, 4); // 4 is right mouse button
                cornerstoneTools.probe.deactivate(element, 1);
                cornerstoneTools.length.deactivate(element, 1);
                cornerstoneTools.ellipticalRoi.deactivate(element, 1);
                cornerstoneTools.rectangleRoi.deactivate(element, 1);
                cornerstoneTools.stackScroll.deactivate(element, 1);
            }

            var buttons = $(studyViewer).find('button');
            // Tool button event handlers that set the new active tool
            $(buttons[0]).click(function() {
                disableAllTools();
                cornerstoneTools.wwwc.activate(element, 1);
            });
            $(buttons[1]).click(function() {
                disableAllTools();
                cornerstoneTools.zoom.activate(element, 5); // 5 is right mouse button and left mouse button
            });
            $(buttons[2]).click(function() {
                disableAllTools();
                cornerstoneTools.pan.activate(element, 3); // 3 is middle mouse button and left mouse button
            });
            $(buttons[3]).click(function() {
                disableAllTools();
                cornerstoneTools.stackScroll.activate(element, 1);
            });
            $(buttons[4]).click(function() {
                disableAllTools();
                cornerstoneTools.length.activate(element, 1);
            });
            $(buttons[5]).click(function() {
                disableAllTools();
                cornerstoneTools.probe.activate(element, 1);
            });
            $(buttons[6]).click(function() {
                disableAllTools();
                cornerstoneTools.ellipticalRoi.activate(element, 1);
            });
            $(buttons[7]).click(function() {
                disableAllTools();
                cornerstoneTools.rectangleRoi.activate(element, 1);
            });
            $(buttons[0]).tooltip();
            $(buttons[1]).tooltip();
            $(buttons[2]).tooltip();
            $(buttons[3]).tooltip();
            $(buttons[4]).tooltip();
            $(buttons[5]).tooltip();
            $(buttons[6]).tooltip();
            $(buttons[7]).tooltip();

            var seriesList = $(studyViewer).find('.list-group')[0];
            stacks.forEach(function(stack) {
                var seriesEntry = '<a class="list-group-item">' + stack.seriesDescription + '</a>';
                var seriesElement = $(seriesEntry).appendTo(seriesList);
                $(seriesElement).click(function () {
                    // make this series visible
                    cornerstoneTools.stackScroll.disable(element);
                    cornerstoneTools.stackScroll.enable(element, stacks[stack.seriesIndex], 0);
                    cornerstone.showImage(element, stacks[stack.seriesIndex].imageIds[0]);
                    var stackState = cornerstoneTools.getToolState(element, 'stack');
                    stackState.data[0] = stacks[stack.seriesIndex];
                    stackState.data[0].currentImageIdIndex = 0;
                    cornerstoneTools.stackPrefetch.enable(element);
                    $(bottomLeft[1]).text("# Images: " + stacks[stack.seriesIndex].imageIds.length);
                });
            });
        });
    }


    $.getJSON('studyList.json', function(data)
    {
        data.studyList.forEach(function(study) {
            var studyRow = '<tr><td>' +
                    study.patientName + '</td><td>' +
                    study.patientId + '</td><td>' +
                    study.studyDate + '</td><td>' +
                    study.modality + '</td><td>' +
                    study.studyDescription + '</td><td>' +
                    study.numImages + '</td><td>' +
                    '</tr>';
             var studyRowElement = $(studyRow).appendTo('#studyListData');
            $(studyRowElement).click(function() {
                // Add new tab for this study and switch to it
                var studyTab = '<li><a href="#x' + study.patientId + '" data-toggle="tab">' + study.patientName + '</a></li>';
                $('#tabs').append(studyTab);

                // add tab content by making a copy of the studyViewerTemplate element
                var studyViewerCopy = $('#studyViewerTemplate').clone();
                studyViewerCopy.attr("id", 'x' + study.patientId);
                studyViewerCopy.removeClass('hidden');
                studyViewerCopy.appendTo('#tabContent');

                // show the new tab (which will be the last one since it was just added
                $('#tabs a:last').tab('show');

                // Now load the study.json
                loadStudyJson(studyViewerCopy, study.studyId + ".json");
            });
        });
    });

    $("#help").click(function() {
        $("#myModal").modal();
    });



</script>

</body>
</html>
