<!DOCTYPE HTML>
<html>
<head>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>

    .hidden {
        display: none;
    }

    /* prevents selection when left click dragging */
    .disable-selection {
        -moz-user-select: none; -webkit-user-select: none; -ms-user-select:none; user-select:none;
    }

    /* prevents cursor from changing to the i bar on the overlays*/
    .noIbar {
        cursor:default;
    }

    /* images are displayed in viewports */
    .viewport {
        width:512px;
        height:512px;
        top:0px;
        left:0px;
        position:absolute
    }

    .overlay {
        position: absolute
    }
</style>
<body>
<div id="wrap">
    <div class="container">

        <div class="page-header">
            <h1>
                Cornerstone Demo
            </h1>
            <div class="well">
                <ol>
                    <li>Select a study in the study list to view its images, a new tab will be created for each study.</li>
                    <li>Interact with the image using your mouse: left click drag - ww/wl, middle click drag - pan, right click drag - zoom, mouse wheel - scroll through stack</li>
                    <li>Select another series to display by left click the series list on the left</li>
                    <li>Select another tool to use with the left mouse button by selecting the tool button</li>
                </ol>
            </div>
        </div>

        <ul id="tabs" class="nav nav-tabs">
            <li class="active"><a href="#studyList" data-toggle="tab">Study List</a></li>
        </ul>

        <div id="tabContent" class="tab-content">
            <div id="studyList" class="tab-pane active">
                <div class="row">
                    <table class="col-md-12 table table-striped">
                        <thead>
                        <tr>
                            <th>Patient Name</th>
                            <th>Patient ID</th>
                            <th>Study Date</th>
                            <th>Modality</th>
                            <th>Study Description</th>
                            <th># Images</th>
                        </tr>
                        </thead>
                        <tbody id="studyListData">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="studyViewerTemplate" class="tab-pane active hidden">
            <div class="row">
                <div class="col-xs-2">
                    <h4>Select Series</h4>
                    <div class="list-group">
                    </div>
                </div>
                <div class="col-xs-8">
                    <br>
                    <button type="button" class="btn">WW/WC</button>
                    <button type="button" class="btn">Zoom</button>
                    <button type="button" class="btn">Pan</button>
                    <button type="button" class="btn">Scroll</button>
                    <button type="button" class="btn">Length</button>
                    <button type="button" class="btn">Probe</button>
                    <button type="button" class="btn">Elliptical ROI</button>
                    <button type="button" class="btn">Rectangle ROI</button>
                    <br>
                    <div style="width:512px;height:512px;position:relative;color: white;display:inline-block;background-color:black;"
                         oncontextmenu="return false"
                         class='disable-selection noIbar'
                         unselectable='on'
                         onselectstart='return false;'
                         onmousedown='return false;'>
                        <div class="viewport">
                        </div>
                        <div class="overlay" style="top:0px; left:0px">
                            <div>Patient Name</div>
                            <div>Patient Id</div>
                        </div>
                        <div class="overlay" style="top:0px; right:0px">
                            <div>Study Description</div>
                            <div>Study Date</div>
                        </div>
                        <div class="overlay" style="bottom:0px; right:0px">
                            <div>Image #:</div>
                            <div>Zoom:</div>
                        </div>
                        <div class="overlay" style="bottom:0px; left:0px">
                            WW/WC:
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

<div id="footer">
    <div class="navbar navbar-inner navbar-fixed-bottom container">
        <strong>This demo requires a HTLM5 browser, Google Chrome is recommended</strong>
        <br>
        Read about the <a href="architecture.html">architecture</a> for this demo
    </div>
</div>

</div>

<script src="https://code.jquery.com/jquery-2.1.0.min.js"></script>

<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" ></script>

<!-- include the cornerstone library -->
<script src="cornerstone.js"></script>

<!-- include the cornerstone tools library -->
<script src="cornerstone-tools.js"></script>

<!-- include the cornerstoneWADOImageLoader library -->
<script src="cornerstoneWADOImageLoader.js"></script>

<!-- include the cornerstoneWADOImageLoader library -->
<script src="dicomParser.js"></script>

    <script>

    $('#tabs a').click(function (e) {
        e.preventDefault()
        $(this).tab('show')
    })

    function loadStudyJson(studyViewer, studyId)
    {
        $.getJSON('studies/' + studyId, function(data) {
            // Load the first series into the viewport
            $('#wadoURL').val();

            var stacks = [];

            var seriesIndex = 0;
            data.seriesList.forEach(function(series) {
                var stack = {
                    seriesDescription: series.seriesDescription,
                    stackId : series.seriesNumber,
                    imageIds: [],
                    seriesIndex : seriesIndex,
                    currentImageIdIndex: 0,
                }
                series.instanceList.forEach(function(image) {
                    var imageId = "http://cornerstonetech.org/images/ClearCanvas/" + image.imageId;
                    stack.imageIds.push(imageId);
                });
                seriesIndex++;
                stacks.push(stack);
            });

            // image enable the dicomImage element and activate a few tools
            var element = $(studyViewer).find('.viewport')[0];
            var parent = $(element).parent();
            var childDivs = $(parent).find('.overlay');
            var topLeft = $(childDivs[0]).find('div');
            $(topLeft[0]).text(data.patientName);
            $(topLeft[1]).text(data.patientId);
            var topRight= $(childDivs[1]).find('div');
            $(topRight[0]).text(data.studyDescription);
            $(topRight[1]).text(data.studyDate);
            var bottomLeft = $(childDivs[2]).find('div');
            $(bottomLeft[1]).text("# Images: " + stacks[0].imageIds.length);

            function onViewportUpdated(e) {
                $(childDivs[3]).text("WW/WL:" + Math.round(e.detail.viewport.windowWidth) + "/" + Math.round(e.detail.viewport.windowCenter));
                $(bottomLeft[0]).text("Zoom:" + e.detail.viewport.scale.toFixed(2));
            };
            element.addEventListener("CornerstoneViewportUpdated", onViewportUpdated, false);


            var imageId = stacks[0].imageIds[0];

            // image enable the dicomImage element
            cornerstone.enable(element, imageId);
            cornerstoneTools.mouseInput.enable(element);
            cornerstoneTools.mouseWheelInput.enable(element);

            // Enable all tools we want to use with this element
            cornerstoneTools.wwwc.activate(element, 1); // ww/wc is the default tool for left mouse button
            cornerstoneTools.pan.activate(element, 2); // pan is the default tool for middle mouse button
            cornerstoneTools.zoom.activate(element, 4); // zoom is the default tool for right mouse button
            cornerstoneTools.probe.enable(element);
            cornerstoneTools.length.enable(element);
            cornerstoneTools.ellipticalRoi.enable(element);
            cornerstoneTools.rectangleRoi.enable(element);


            // stack tools
            cornerstoneTools.addStackStateManager(element);
            cornerstoneTools.addToolState(element, 'stack', stacks[0]);
            cornerstoneTools.stackScrollWheel.activate(element);
            cornerstoneTools.stackPrefetch.enable(element);


            function disableAllTools()
            {
                cornerstoneTools.wwwc.disable(element);
                cornerstoneTools.pan.activate(element, 2); // 2 is middle mouse button
                cornerstoneTools.zoom.activate(element, 4); // 4 is right mouse button
                cornerstoneTools.probe.deactivate(element, 1);
                cornerstoneTools.length.deactivate(element, 1);
                cornerstoneTools.ellipticalRoi.deactivate(element, 1);
                cornerstoneTools.rectangleRoi.deactivate(element, 1);
            }

            var buttons = $(studyViewer).find('button');
            // Tool button event handlers that set the new active tool
            $(buttons[0]).click(function() {
                disableAllTools();
                cornerstoneTools.wwwc.activate(element, 1);
            });
            $(buttons[1]).click(function() {
                disableAllTools();
                cornerstoneTools.zoom.activate(element, 5); // 5 is right mouse button and left mouse button
            });
            $(buttons[2]).click(function() {
                disableAllTools();
                cornerstoneTools.pan.activate(element, 3); // 3 is middle mouse button and left mouse button
            });
            $(buttons[3]).click(function() {
                disableAllTools();
                cornerstoneTools.stackScroll.activate(element, 1);
            });
            $(buttons[4]).click(function() {
                disableAllTools();
                cornerstoneTools.length.activate(element, 1);
            });
            $(buttons[5]).click(function() {
                disableAllTools();
                cornerstoneTools.probe.activate(element, 1);
            });
            $(buttons[6]).click(function() {
                disableAllTools();
                cornerstoneTools.ellipticalRoi.activate(element, 1);
            });
            $(buttons[7]).click(function() {
                disableAllTools();
                cornerstoneTools.rectangleRoi.activate(element, 1);
            });

            var seriesList = $(studyViewer).find('.list-group')[0];
            stacks.forEach(function(stack) {
                var seriesEntry = '<a class="list-group-item">' + stack.seriesDescription + '</a>';
                var seriesElement = $(seriesEntry).appendTo(seriesList);
                $(seriesElement).click(function () {
                    // make this series visible
                    cornerstoneTools.stackScroll.disable(element);
                    cornerstoneTools.stackScroll.enable(element, stacks[stack.seriesIndex], 0);
                    cornerstone.newStack(element, stacks[stack.seriesIndex].imageIds[0]);
                    var stackState = cornerstoneTools.getToolState(element, 'stack');
                    stackState.data[0] = stacks[stack.seriesIndex];
                    cornerstoneTools.stackPrefetch.enable(element);
                    $(bottomLeft[1]).text("# Images: " + stacks[stack.seriesIndex].imageIds.length);
                });
            });
        });
    }


    $.getJSON('studyList.json', function(data)
    {
        data.studyList.forEach(function(study) {
            var studyRow = '<tr><td>' +
                    study.patientName + '</td><td>' +
                    study.patientId + '</td><td>' +
                    study.studyDate + '</td><td>' +
                    study.modality + '</td><td>' +
                    study.studyDescription + '</td><td>' +
                    study.numImages + '</td><td>' +
                    '</tr>';
             var studyRowElement = $(studyRow).appendTo('#studyListData');
            $(studyRowElement).click(function() {
                // Add new tab for this study and switch to it
                var studyTab = '<li><a href="#x' + study.patientId + '" data-toggle="tab">' + study.patientName + '</a></li>';
                $('#tabs').append(studyTab);

                // add tab content by making a copy of the studyViewerTemplate element
                var studyViewerCopy = $('#studyViewerTemplate').clone();
                studyViewerCopy.attr("id", 'x' + study.patientId);
                studyViewerCopy.removeClass('hidden');
                studyViewerCopy.appendTo('#tabContent');

                // show the new tab (which will be the last one since it was just added
                $('#tabs a:last').tab('show');

                // Now load the study.json
                loadStudyJson(studyViewerCopy, study.studyId + ".json");
            });
        });
    });

</script>

</body>
</html>
